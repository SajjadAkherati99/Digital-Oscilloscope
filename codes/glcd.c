#include "glcd.h"
#include "gpio.h"




Glcd_Config_st glcdConfig;            //Structure containing the selected LCD Configuration


uint8_t shadowBuffer[8][128];
uint8_t ARR_GlcdFont_U8[][7] = {
        {0x00,0x00,0x00,0x00,0x00,0xff,0xff}, /* Space 0x20 */
        {0x00,0x00,0x4f,0x00,0x00,0x00,0xff}, /* ! */
        {0x00,0x07,0x00,0x07,0x00,0x00,0xff}, /* " */
        {0x14,0x7f,0x14,0x7f,0x14,0x00,0xff}, /* # */
        {0x24,0x2a,0x7f,0x2a,0x12,0x00,0xff}, /* 0x */
        {0x23,0x13,0x08,0x64,0x62,0x00,0xff}, /* % */
        {0x36,0x49,0x55,0x22,0x20,0x00,0xff}, /* & */
        {0x00,0x05,0x03,0x00,0x00,0x00,0xff}, /* ' */
        {0x00,0x1c,0x22,0x41,0x00,0x00,0xff}, /* ( */
        {0x00,0x41,0x22,0x1c,0x00,0x00,0xff}, /* ) */
        {0x14,0x08,0x3e,0x08,0x14,0x00,0xff}, /* // */
        {0x08,0x08,0x3e,0x08,0x08,0x00,0xff}, /* + */
        {0x50,0x30,0x00,0x00,0x00,0x00,0xff}, /* , */
        {0x08,0x08,0x08,0x08,0x08,0x00,0xff}, /* - */
        {0x00,0x60,0x60,0x00,0x00,0x00,0xff}, /* . */
        {0x20,0x10,0x08,0x04,0x02,0x00,0xff}, /* / */
        {0x3e,0x51,0x49,0x45,0x3e,0x00,0xff}, /* 0 0x30 */
        {0x40,0x42,0x7f,0x40,0x40,0x00,0xff}, /* 1 */
        {0x42,0x61,0x51,0x49,0x46,0x00,0xff}, /* 2 */
        {0x21,0x41,0x45,0x4b,0x31,0x00,0xff}, /* 3 */
        {0x18,0x14,0x12,0x7f,0x10,0x00,0xff}, /* 4 */
        {0x27,0x45,0x45,0x45,0x39,0x00,0xff}, /* 5 */
        {0x3c,0x4a,0x49,0x49,0x30,0x00,0xff}, /* 6 */
        {0x01,0x71,0x09,0x05,0x03,0x00,0xff}, /* 7 */
        {0x36,0x49,0x49,0x49,0x36,0x00,0xff}, /* 8 */
        {0x06,0x49,0x49,0x29,0x1e,0x00,0xff}, /* 9 */
        {0x00,0x36,0x36,0x00,0x00,0x00,0xff}, /* : */
        {0x00,0x56,0x36,0x00,0x00,0x00,0xff}, /* ; */
        {0x08,0x14,0x22,0x41,0x00,0x00,0xff}, /* < */
        {0x14,0x14,0x14,0x14,0x14,0x00,0xff}, /* = */
        {0x00,0x41,0x22,0x14,0x08,0x00,0xff}, /* > */
        {0x02,0x01,0x51,0x09,0x06,0x00,0xff}, /* ? */
        {0x3e,0x41,0x5d,0x55,0x1e,0x00,0xff}, /* @ 0x40 */
        {0x7e,0x11,0x11,0x11,0x7e,0x00,0xff}, /* A */
        {0x7f,0x49,0x49,0x49,0x36,0x00,0xff}, /* B */
        {0x3e,0x41,0x41,0x41,0x22,0x00,0xff}, /* C */
        {0x7f,0x41,0x41,0x22,0x1c,0x00,0xff}, /* D */
        {0x7f,0x49,0x49,0x49,0x41,0x00,0xff}, /* E */
        {0x7f,0x09,0x09,0x09,0x01,0x00,0xff}, /* F */
        {0x3e,0x41,0x49,0x49,0x7a,0x00,0xff}, /* G */
        {0x7f,0x08,0x08,0x08,0x7f,0x00,0xff}, /* H */
        {0x00,0x41,0x7f,0x41,0x00,0x00,0xff}, /* I */
        {0x20,0x40,0x41,0x3f,0x01,0x00,0xff}, /* J */
        {0x7f,0x08,0x14,0x22,0x41,0x00,0xff}, /* K */
        {0x7f,0x40,0x40,0x40,0x40,0x00,0xff}, /* L */
        {0x7f,0x02,0x0c,0x02,0x7f,0x00,0xff}, /* M */
        {0x7f,0x04,0x08,0x10,0x7f,0x00,0xff}, /* N */
        {0x3e,0x41,0x41,0x41,0x3e,0x00,0xff}, /* O */
        {0x7f,0x09,0x09,0x09,0x06,0x00,0xff}, /* P 0x50 */
        {0x3e,0x41,0x51,0x21,0x5e,0x00,0xff}, /* Q */
        {0x7f,0x09,0x19,0x29,0x46,0x00,0xff}, /* R */
        {0x26,0x49,0x49,0x49,0x32,0x00,0xff}, /* S */
        {0x01,0x01,0x7f,0x01,0x01,0x00,0xff}, /* T */
        {0x3f,0x40,0x40,0x40,0x3f,0x00,0xff}, /* U */
        {0x1f,0x20,0x40,0x20,0x1f,0x00,0xff}, /* V */
        {0x3f,0x40,0x38,0x40,0x3f,0x00,0xff}, /* W */
        {0x63,0x14,0x08,0x14,0x63,0x00,0xff}, /* X */
        {0x07,0x08,0x70,0x08,0x07,0x00,0xff}, /* Y */
        {0x61,0x51,0x49,0x45,0x43,0x00,0xff}, /* Z */
        {0x00,0x7f,0x41,0x41,0x00,0x00,0xff}, /* [ */
        {0x02,0x04,0x08,0x10,0x20,0x00,0xff}, /* \ */
        {0x00,0x41,0x41,0x7f,0x00,0x00,0xff}, /* ] */
        {0x04,0x02,0x01,0x02,0x04,0x00,0xff}, /* ^ */
        {0x40,0x40,0x40,0x40,0x40,0x00,0xff}, /* _ */
        {0x00,0x00,0x03,0x05,0x00,0x00,0xff}, /* ` 0x60 */
        {0x20,0x54,0x54,0x54,0x78,0x00,0xff}, /* a */
        {0x7F,0x44,0x44,0x44,0x38,0x00,0xff}, /* b */
        {0x38,0x44,0x44,0x44,0x44,0x00,0xff}, /* c */
        {0x38,0x44,0x44,0x44,0x7f,0x00,0xff}, /* d */
        {0x38,0x54,0x54,0x54,0x18,0x00,0xff}, /* e */
        {0x04,0x04,0x7e,0x05,0x05,0x00,0xff}, /* f */
        {0x08,0x54,0x54,0x54,0x3c,0x00,0xff}, /* g */
        {0x7f,0x08,0x04,0x04,0x78,0x00,0xff}, /* h */
        {0x00,0x44,0x7d,0x40,0x00,0xff,0xff}, /* i */
        {0x20,0x40,0x44,0x3d,0x00,0xff,0xff}, /* j */
        {0x7f,0x10,0x28,0x44,0x00,0xff,0xff}, /* k */
        {0x41,0x7f,0x40,0x00,0xff,0xff,0xff}, /* l */
        {0x7c,0x04,0x7c,0x04,0x78,0x00,0xff}, /* m */
        {0x7c,0x08,0x04,0x04,0x78,0x00,0xff}, /* n */
        {0x38,0x44,0x44,0x44,0x38,0x00,0xff}, /* o */
        {0x7c,0x14,0x14,0x14,0x08,0x00,0xff}, /* p 0x70 */
        {0x08,0x14,0x14,0x14,0x7c,0x00,0xff}, /* q */
        {0x7c,0x08,0x04,0x04,0x00,0xff,0xff}, /* r */
        {0x48,0x54,0x54,0x54,0x24,0x00,0xff}, /* s */
        {0x04,0x04,0x3f,0x44,0x44,0x00,0xff}, /* t */
        {0x3c,0x40,0x40,0x20,0x7c,0x00,0xff}, /* u */
        {0x1c,0x20,0x40,0x20,0x1c,0x00,0xff}, /* v */
        {0x3c,0x40,0x30,0x40,0x3c,0x00,0xff}, /* w */
        {0x44,0x28,0x10,0x28,0x44,0x00,0xff}, /* x */
        {0x0c,0x50,0x50,0x50,0x3c,0x00,0xff}, /* y */
        {0x44,0x64,0x54,0x4c,0x44,0x00,0xff}, /* z */
        {0x08,0x36,0x41,0x41,0x00,0x00,0xff}, /* { */
        {0x00,0x00,0x77,0x00,0x00,0x00,0xff}, /* | */
        {0x00,0x41,0x41,0x36,0x08,0x00,0xff}, /* } */
        {0x08,0x08,0x2a,0x1c,0x08,0x00,0xff}, /* <- */
        {0x08,0x1c,0x2a,0x08,0x08,0x00,0xff}, /* -> */
        {0xff,0xff,0xff,0xff,0xff,0x00,0xff}, /*  0x80 */
};


static void glcd_SelectPage0(void);
static void glcd_SelectPage1(void);
void glcd_CmdWrite( uint8_t var_cmd_u8);
void glcd_DataWrite( uint8_t var_data_u8);
static void glcd_SendData(uint8_t dataByte);
void glcd_BusyCheck(void);


void GLCD_SetUp(
	      gpioPins_et RS,
        gpioPins_et RW,
        gpioPins_et EN,
	      gpioPins_et CS1,
        gpioPins_et CS2,
        gpioPins_et D0,
        gpioPins_et D1,
        gpioPins_et D2,
        gpioPins_et D3,
        gpioPins_et D4,
        gpioPins_et D5,
        gpioPins_et D6,
        gpioPins_et D7 )
{
	
    glcdConfig.RS = RS;
    glcdConfig.RW = RW;
    glcdConfig.EN = EN;
	  glcdConfig.CS1 = CS1;
    glcdConfig.CS2 = CS2;

    glcdConfig.D0 = D0;
    glcdConfig.D1 = D1;
    glcdConfig.D2 = D2;
    glcdConfig.D3 = D3;
    glcdConfig.D4 = D4;
    glcdConfig.D5 = D5;
    glcdConfig.D6 = D6;
    glcdConfig.D7 = D7;

    
    GPIO_PinDirection(CS1,OUTPUT);
    GPIO_PinDirection(CS2,OUTPUT);
    GPIO_PinDirection(RS,OUTPUT);
    GPIO_PinDirection(RW,OUTPUT);
    GPIO_PinDirection(EN,OUTPUT);

    GPIO_PinDirection(D0,OUTPUT);
    GPIO_PinDirection(D1,OUTPUT);
    GPIO_PinDirection(D2,OUTPUT);
    GPIO_PinDirection(D3,OUTPUT);
    GPIO_PinDirection(D4,OUTPUT);
    GPIO_PinDirection(D5,OUTPUT);
    GPIO_PinDirection(D6,OUTPUT);
    GPIO_PinDirection(D7,OUTPUT);  

}


void GLCD_Init()
{
    glcdConfig.LineNum = 0xB8;
    glcdConfig.PageNum = 0;
    glcdConfig.CursorPos = 0x40;
    glcd_SelectPage0();
    glcd_CmdWrite(0x3f);
    glcd_SelectPage1();
    glcd_CmdWrite(0x3f);
    DELAY_ms(10);

    glcd_SelectPage0();
    glcd_CmdWrite(0xc0);
    glcd_SelectPage1();
    glcd_CmdWrite(0xc0);
    GLCD_GoToPage(0);

    GLCD_Clear();
}

static void glcd_SelectPage0() 
{


    GPIO_PinWrite(glcdConfig.CS1,1);
    GPIO_PinWrite(glcdConfig.CS2,0);
    glcdConfig.PageNum=0;
}


static void glcd_SelectPage1() 
{

    GPIO_PinWrite(glcdConfig.CS1,0);
    GPIO_PinWrite(glcdConfig.CS2,1);

    glcdConfig.PageNum=1;

}


static void glcd_SendData(uint8_t dataByte)
{

    GPIO_PinWrite(glcdConfig.D0,((dataByte) & 0x01));
    GPIO_PinWrite(glcdConfig.D1,((dataByte >> 1) & 0x01));
    GPIO_PinWrite(glcdConfig.D2,((dataByte >> 2) & 0x01));
    GPIO_PinWrite(glcdConfig.D3,((dataByte >> 3) & 0x01));
    GPIO_PinWrite(glcdConfig.D4,((dataByte >> 4) & 0x01));
    GPIO_PinWrite(glcdConfig.D5,((dataByte >> 5) & 0x01));
    GPIO_PinWrite(glcdConfig.D6,((dataByte >> 6) & 0x01));
    GPIO_PinWrite(glcdConfig.D7,((dataByte >> 7) & 0x01));
}


void glcd_CmdWrite( uint8_t var_glcdCmd_u8)
{
    glcd_BusyCheck();
    glcd_SendData((var_glcdCmd_u8));

    GPIO_PinWrite(glcdConfig.RS,0);
    GPIO_PinWrite(glcdConfig.RW,0);
    GPIO_PinWrite(glcdConfig.EN,1);
    DELAY_us(1);
    GPIO_PinWrite(glcdConfig.EN,0);
    DELAY_us(1);
}


void glcd_DataWrite( uint8_t var_data_u8)
{
    uint8_t temp;

    glcd_BusyCheck();
    temp = var_data_u8; 
    glcd_SendData(temp);

    GPIO_PinWrite(glcdConfig.RS,1);
    GPIO_PinWrite(glcdConfig.RW,0);
    GPIO_PinWrite(glcdConfig.EN,1);
    DELAY_us(1);
    GPIO_PinWrite(glcdConfig.EN,0);
    DELAY_us(1);

    shadowBuffer[glcdConfig.LineNum-C_FirstLineNumberAddress_U8][(glcdConfig.PageNum*64)+glcdConfig.CursorPos] = var_data_u8;
    glcdConfig.CursorPos++;
    if((glcdConfig.PageNum == 0x01) && (glcdConfig.CursorPos==0x80))
        GLCD_GoToNextLine();
}


void glcd_BusyCheck()
{
    DELAY_us(10);
}

void GLCD_Clear()
{
    uint8_t line,cursor;

    for(line=0;line<8;line++)
    {
        GLCD_GoToLine(line);
        for(cursor=0;cursor<128;cursor++) 
        {
            if(cursor==64)  
            {
                GLCD_GoToPage(1); 
            }

            glcd_DataWrite(0x00);
        }
    }

    GLCD_GoToLine(0);
}


void GLCD_EnableDisplayInversion()
{
    glcdConfig.InvertDisplay = 0xff;
}



void GLCD_DisableDisplayInversion()
{
    glcdConfig.InvertDisplay = 0x00;
}



#if (ENABLE_GLCD_SetDot ==1)
void GLCD_SetDot(uint8_t var_x_u8, uint8_t var_y_u8, uint8_t var_color_u8)
{
    uint8_t v_dataRead_u8;

    if ((var_x_u8<128)&&(var_y_u8<64))				 
    {
        v_dataRead_u8 = GLCD_GetXYData(var_x_u8,var_y_u8);

        var_y_u8 = util_GetMod8(var_y_u8,8);		 

        if (var_color_u8)						
            util_BitSet(v_dataRead_u8,var_y_u8);
        else
            util_BitClear(v_dataRead_u8,var_y_u8);

        glcd_DataWrite(v_dataRead_u8^glcdConfig.InvertDisplay);
    }

}
#endif


#if (ENABLE_GLCD_DrawHoriLine == 1)
void GLCD_DrawHoriLine(uint8_t var_x_u8, uint8_t var_y_u8, uint8_t var_length_u8,uint8_t var_color_u8)
{

    if ((var_x_u8<128)&&(var_y_u8<64))					
    {
        var_length_u8++;
        while(var_length_u8)
        {

							GLCD_SetDot(var_x_u8,var_y_u8,var_color_u8);

            if ((glcdConfig.CursorPos >0x7F) && (glcdConfig.PageNum == 1)) 
                return;		   								 

            var_x_u8++;
            var_length_u8--;
        }
    }


}
#endif


#if ((ENABLE_GLCD_DrawVertLine ==1) || (ENABLE_GLCD_DrawLine==1))
void GLCD_DrawVertLine(uint8_t var_x_u8, uint8_t var_y_u8, uint8_t var_length_u8, uint8_t var_color_u8)
{

    if ((var_x_u8<128)&&(var_y_u8<64))				
    {
        while(var_length_u8)
        {
            GLCD_SetDot(var_x_u8,var_y_u8,var_color_u8);

            if (glcdConfig.LineNum > C_LastLineNumberAddress_U8)	
                return;

            var_y_u8++;
            var_length_u8--;            
        }
    }

}
#endif


#if (ENABLE_GLCD_GetXYData ==1)
uint8_t GLCD_GetXYData(uint8_t var_x_u8, uint8_t var_y_u8)
{
    uint8_t v_dataRead_u8 = 0;

    if ((var_x_u8<128)&&(var_y_u8<64))
    {
        if(var_x_u8 > 63) 
        {
            glcd_SelectPage1();
            glcdConfig.PageNum=1;
            glcdConfig.CursorPos= var_x_u8-64;
        }
        else
        {
            glcd_SelectPage0();
            glcdConfig.PageNum=0;
            glcdConfig.CursorPos= var_x_u8 ;
        }

        glcdConfig.LineNum=C_FirstLineNumberAddress_U8 + (var_y_u8 >> 3);	
        GLCD_SetCursor(glcdConfig.PageNum,glcdConfig.LineNum,glcdConfig.CursorPos);

        v_dataRead_u8 = GLCD_DataRead();
    }
    return (v_dataRead_u8);
}
#endif


void GLCD_GoToPage(uint8_t pageNumber)
{

    if((pageNumber==0) || (pageNumber ==1))
    { 
        if(pageNumber == 0)
        {

            glcd_SelectPage0();
        }
        else
        {
            glcd_SelectPage1();
        }
        glcdConfig.PageNum=pageNumber;
        glcdConfig.CursorPos=0x40;
        glcd_CmdWrite(glcdConfig.LineNum);
        glcd_CmdWrite(glcdConfig.CursorPos);
    }
}


void  GLCD_GoToNextLine()
{
    glcdConfig.LineNum++;
    if(glcdConfig.LineNum > C_LastLineNumberAddress_U8)
        glcdConfig.LineNum = C_FirstLineNumberAddress_U8;
    GLCD_GoToPage(0); 
}


#if (ENABLE_GLCD_DataRead ==1) 
uint8_t GLCD_DataRead(void)
{
    uint8_t v_dataRead_u8;

    v_dataRead_u8 = shadowBuffer[glcdConfig.LineNum-C_FirstLineNumberAddress_U8][(glcdConfig.PageNum*64)+glcdConfig.CursorPos];

    return(v_dataRead_u8);
}
#endif


void  GLCD_GoToLine(uint8_t var_lineNumber_u8)
{
    if(var_lineNumber_u8<8)
    {   
        glcdConfig.LineNum = var_lineNumber_u8+C_FirstLineNumberAddress_U8;
        GLCD_GoToPage(0);
    }
}


void GLCD_SetCursor(uint8_t pageNumber,uint8_t lineNumber,uint8_t CursorPosition)
{
    if(((pageNumber == 0x00)   || (pageNumber == 0x01)) && (lineNumber <= C_GlcdLastLine_U8) && (CursorPosition < 64) )
    {
        if(pageNumber==0x00) 
        {
            glcd_SelectPage0();
        }
        else
        {
            glcd_SelectPage1();
        }
    }

    glcdConfig.PageNum = pageNumber; 
    glcdConfig.LineNum=lineNumber | C_FirstLineNumberAddress_U8; 
    glcdConfig.CursorPos=CursorPosition |0x40; 

    glcd_CmdWrite(glcdConfig.CursorPos); 
    glcd_CmdWrite(glcdConfig.LineNum);
}

void GLCD_GetCursor(uint8_t *page_ptr,uint8_t *line_ptr,uint8_t *cursor_ptr)
{

    *page_ptr=glcdConfig.PageNum;
    *line_ptr=glcdConfig.LineNum - C_FirstLineNumberAddress_U8;
    *cursor_ptr=glcdConfig.CursorPos;
}

